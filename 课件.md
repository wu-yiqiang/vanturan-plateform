# monorepoå·¥ç¨‹ç®¡ç†

## mutirepo vs monorepo

![monorepo vs multirepo](https://resource.duyiedu.com/yuanjin/202509190953043.svg)

å¸¸è§monorepoç®¡ç†å·¥å…·ï¼š

- **pnpm**
- npm
- Yarn
- Lerna
- Nx
- Turborepo
- Rush
- ...

### pnpm monorepo

```shell
touch pnpm-workspace.yaml
```

```yaml
# pnpm-workspace.yaml

packages:
  - "packages/*"
  - "apps/*"
```

æ‰§è¡Œå·¥ç¨‹çº§å‘½ä»¤

```shell
pnpm --workspace-root [...]
```

æˆ–

```shell
pnpm -w [...]
```

æ‰§è¡Œå­åŒ…å‘½ä»¤

```shell
è¿›å…¥å­ç›®å½•ä¸­æ‰§è¡Œ
```

æˆ–

```shell
pnpm -C å­åŒ…è·¯å¾„ [...]
```

## ç¯å¢ƒç‰ˆæœ¬é”å®š

```json
// package.json
"engines": {
  "node": ">=22.14.0",
  "npm": ">=10.9.2",
  "pnpm": ">=10.15.1"
}
```

```yaml
# .npmrc
engine-strict=true
```

## TypeScript

```shell
pnpm -Dw add typescript @types/node
```

```shell
touch tsconfig.json
```

```json
// tsconfig.json
{
  "compilerOptions": {
    "baseUrl": ".",
    "module": "esnext",
    "target": "esnext",
    "types": [],
    "lib": ["esnext"],
    "sourceMap": true,
    "declaration": true,
    "declarationMap": true,
    "noUncheckedIndexedAccess": true,
    "exactOptionalPropertyTypes": true,
    "strict": true,
    "verbatimModuleSyntax": false,
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "noUncheckedSideEffectImports": true,
    "moduleDetection": "force",
    "skipLibCheck": true
  },
  "exclude": ["node_modules", "dist"]
}
```

```json
// apps/backend/tsconfig.json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "types": ["node"],
    "lib": ["esnext"]
  },
  "include": ["src"]
}
```

```json
// apps/frontend/tsconfig.json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "types": ["node"],
    "lib": ["esnext", "DOM"]
  },
  "include": ["src"]
}
```

## ä»£ç é£æ ¼ä¸è´¨é‡æ£€æŸ¥

### prettier

`prettier`å®‰è£…

```shell
pnpm -Dw add prettier
```

`prettier`é…ç½®

```shell
touch prettier.config.js
```

```js
// prettier.config.js
/**
 * @type {import('prettier').Config}
 * @see https://www.prettier.cn/docs/options.html
 */
export default {
  // æŒ‡å®šæœ€å¤§æ¢è¡Œé•¿åº¦
  printWidth: 120,
  // ç¼©è¿›åˆ¶è¡¨ç¬¦å®½åº¦ | ç©ºæ ¼æ•°
  tabWidth: 2,
  // ä½¿ç”¨åˆ¶è¡¨ç¬¦è€Œä¸æ˜¯ç©ºæ ¼ç¼©è¿›è¡Œ (trueï¼šåˆ¶è¡¨ç¬¦ï¼Œfalseï¼šç©ºæ ¼)
  useTabs: false,
  // ç»“å°¾ä¸ç”¨åˆ†å· (trueï¼šæœ‰ï¼Œfalseï¼šæ²¡æœ‰)
  semi: true,
  // ä½¿ç”¨å•å¼•å· (trueï¼šå•å¼•å·ï¼Œfalseï¼šåŒå¼•å·)
  singleQuote: false,
  // åœ¨å¯¹è±¡å­—é¢é‡ä¸­å†³å®šæ˜¯å¦å°†å±æ€§åç”¨å¼•å·æ‹¬èµ·æ¥ å¯é€‰å€¼ "<as-needed|consistent|preserve>"
  quoteProps: "as-needed",
  // åœ¨JSXä¸­ä½¿ç”¨å•å¼•å·è€Œä¸æ˜¯åŒå¼•å· (trueï¼šå•å¼•å·ï¼Œfalseï¼šåŒå¼•å·)
  jsxSingleQuote: false,
  // å¤šè¡Œæ—¶å°½å¯èƒ½æ‰“å°å°¾éšé€—å· å¯é€‰å€¼"<none|es5|all>"
  trailingComma: "none",
  // åœ¨å¯¹è±¡ï¼Œæ•°ç»„æ‹¬å·ä¸æ–‡å­—ä¹‹é—´åŠ ç©ºæ ¼ "{ foo: bar }" (trueï¼šæœ‰ï¼Œfalseï¼šæ²¡æœ‰)
  bracketSpacing: true,
  // å°† > å¤šè¡Œå…ƒç´ æ”¾åœ¨æœ€åä¸€è¡Œçš„æœ«å°¾ï¼Œè€Œä¸æ˜¯å•ç‹¬æ”¾åœ¨ä¸‹ä¸€è¡Œ (trueï¼šæ”¾æœ«å°¾ï¼Œfalseï¼šå•ç‹¬ä¸€è¡Œ)
  bracketSameLine: false,
  // (x) => {} ç®­å¤´å‡½æ•°å‚æ•°åªæœ‰ä¸€ä¸ªæ—¶æ˜¯å¦è¦æœ‰å°æ‹¬å· (avoidï¼šçœç•¥æ‹¬å·ï¼Œalwaysï¼šä¸çœç•¥æ‹¬å·)
  arrowParens: "avoid",
  // æŒ‡å®šè¦ä½¿ç”¨çš„è§£æå™¨ï¼Œä¸éœ€è¦å†™æ–‡ä»¶å¼€å¤´çš„ @prettier
  requirePragma: false,
  // å¯ä»¥åœ¨æ–‡ä»¶é¡¶éƒ¨æ’å…¥ä¸€ä¸ªç‰¹æ®Šæ ‡è®°ï¼ŒæŒ‡å®šè¯¥æ–‡ä»¶å·²ä½¿ç”¨ Prettier æ ¼å¼åŒ–
  insertPragma: false,
  // ç”¨äºæ§åˆ¶æ–‡æœ¬æ˜¯å¦åº”è¯¥è¢«æ¢è¡Œä»¥åŠå¦‚ä½•è¿›è¡Œæ¢è¡Œ
  proseWrap: "preserve",
  // åœ¨htmlä¸­ç©ºæ ¼æ˜¯å¦æ˜¯æ•æ„Ÿçš„ "css" - éµå®ˆ CSS æ˜¾ç¤ºå±æ€§çš„é»˜è®¤å€¼ï¼Œ "strict" - ç©ºæ ¼è¢«è®¤ä¸ºæ˜¯æ•æ„Ÿçš„ ï¼Œ"ignore" - ç©ºæ ¼è¢«è®¤ä¸ºæ˜¯ä¸æ•æ„Ÿçš„
  htmlWhitespaceSensitivity: "css",
  // æ§åˆ¶åœ¨ Vue å•æ–‡ä»¶ç»„ä»¶ä¸­ <script> å’Œ <style> æ ‡ç­¾å†…çš„ä»£ç ç¼©è¿›æ–¹å¼
  vueIndentScriptAndStyle: false,
  // æ¢è¡Œç¬¦ä½¿ç”¨ lf ç»“å°¾æ˜¯ å¯é€‰å€¼ "<auto|lf|crlf|cr>"
  endOfLine: "auto",
  // è¿™ä¸¤ä¸ªé€‰é¡¹å¯ç”¨äºæ ¼å¼åŒ–ä»¥ç»™å®šå­—ç¬¦åç§»é‡ï¼ˆåˆ†åˆ«åŒ…æ‹¬å’Œä¸åŒ…æ‹¬ï¼‰å¼€å§‹å’Œç»“æŸçš„ä»£ç  (rangeStartï¼šå¼€å§‹ï¼ŒrangeEndï¼šç»“æŸ)
  rangeStart: 0,
  rangeEnd: Infinity
};
```

`prettier`å¿½ç•¥é¡¹

```shell
touch .prettierignore
```

```yaml
# .prettierignore
dist
public
.local
node_modules
pnpm-lock.yaml
```

`prettier`è„šæœ¬å‘½ä»¤

```json
"scripts":{
    //......å…¶ä»–çœç•¥
    "lint:prettier": "prettier --write \"**/*.{js,ts,mjs,cjs,json,tsx,css,less,scss,vue,html,md}\"",
}
```

æ‰§è¡Œå‘½ä»¤

```shell
pnpm run lint:prettier
pnpm lint:prettier
```

### ESLint

```shell
pnpm -Dw add eslint@latest @eslint/js globals typescript-eslint eslint-plugin-prettier eslint-config-prettier eslint-plugin-vue
```

| ç±»åˆ«                 | åº“å                                               |
| -------------------- | -------------------------------------------------- |
| **æ ¸å¿ƒå¼•æ“**         | `eslint`                                           |
| **å®˜æ–¹è§„åˆ™é›†**       | `@eslint/js`                                       |
| **å…¨å±€å˜é‡æ”¯æŒ**     | `globals`                                          |
| **TypeScript æ”¯æŒ**  | `typescript-eslint`                                |
| **ç±»å‹å®šä¹‰ï¼ˆè¾…åŠ©ï¼‰** | `@types/node`                                      |
| **Prettier é›†æˆ**    | `eslint-plugin-prettier`, `eslint-config-prettier` |
| **Vue.js æ”¯æŒ**      | `eslint-plugin-vue`                                |

é…ç½®

```shell
touch eslint.config.js
```

```js
import { defineConfig } from "eslint/config";
import eslint from "@eslint/js";
import tseslint from "typescript-eslint";
import eslintPluginPrettier from "eslint-plugin-prettier";
import eslintPluginVue from "eslint-plugin-vue";
import globals from "globals";
import eslintConfigPrettier from "eslint-config-prettier/flat";

const ignores = ["**/dist/**", "**/node_modules/**", ".*", "scripts/**", "**/*.d.ts"];

export default defineConfig(
  // é€šç”¨é…ç½®
  {
    ignores, // å¿½ç•¥é¡¹
    extends: [eslint.configs.recommended, ...tseslint.configs.recommended, eslintConfigPrettier], // ç»§æ‰¿è§„åˆ™
    plugins: {
      prettier: eslintPluginPrettier
    },
    languageOptions: {
      ecmaVersion: "latest", // ecmaè¯­æ³•æ”¯æŒç‰ˆæœ¬
      sourceType: "module", // æ¨¡å—åŒ–ç±»å‹
      parser: tseslint.parser // è§£æå™¨
    },
    rules: {
      // è‡ªå®šä¹‰
    }
  },
  // å‰ç«¯é…ç½®
  {
    ignores,
    files: ["apps/frontend/**/*.{ts,js,tsx,jsx,vue}", "packages/components/**/*.{ts,js,tsx,jsx,vue}"],
    extends: [...eslintPluginVue.configs["flat/recommended"], eslintConfigPrettier],
    languageOptions: {
      globals: {
        ...globals.browser
      }
    }
  },
  // åç«¯é…ç½®
  {
    ignores,
    files: ["apps/backend/**/*.{ts,js}"],
    languageOptions: {
      globals: {
        ...globals.node
      }
    }
  }
);
```

è„šæœ¬å‘½ä»¤

```json
"scripts":{
    //......å…¶ä»–çœç•¥
    "lint:eslint": "eslint",
}
```

### æ‹¼å†™æ£€æŸ¥

vscodeæ’ä»¶ï¼š Code Spell Checker

å®‰è£…

```shell
pnpm -Dw add cspell @cspell/dict-lorem-ipsum
```

é…ç½®

```shell
touch cspell.json
```

```json
{
  "import": ["@cspell/dict-lorem-ipsum/cspell-ext.json"],
  "caseSensitive": false,
  "dictionaries": ["custom-dictionary"],
  "dictionaryDefinitions": [
    {
      "name": "custom-dictionary",
      "path": "./.cspell/custom-dictionary.txt",
      "addWords": true
    }
  ],
  "ignorePaths": [
    "**/node_modules/**",
    "**/dist/**",
    "**/build/**",
    "**/lib/**",
    "**/docs/**",
    "**/vendor/**",
    "**/public/**",
    "**/static/**",
    "**/out/**",
    "**/tmp/**",
    "**/*.d.ts",
    "**/package.json",
    "**/*.md",
    "**/stats.html",
    "eslint.config.mjs",
    ".gitignore",
    ".prettierignore",
    "cspell.json",
    "commitlint.config.js",
    ".cspell"
  ]
}
```

è‡ªå®šä¹‰å­—å…¸

```shell
mkdir -p ./.cspell && touch ./.cspell/custom-dictionary.txt
```

æ£€æŸ¥è„šæœ¬

```json
"lint:spellcheck": "cspell lint \"(packages|apps)/**/*.{js,ts,mjs,cjs,json,css,less,scss,vue,html,md}\""
```

## gitæäº¤è§„èŒƒ

gitä»“åº“åˆ›å»º

```shell
touch .gitignore
```

```yaml
# .gitignore
# Node
node_modules/
dist/
build/
.env
.env.*
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# IDE
.vscode/
.idea/
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

# OS
.DS_Store
Thumbs.db

# TypeScript
*.tsbuildinfo

# Misc
coverage/
*.local
*.cache
*.tmp

# Git
.git/
```

```shell
git init
```

### commitizen

å®‰è£…

```shell
pnpm -Dw add @commitlint/cli @commitlint/config-conventional commitizen cz-git
```

- `@commitlint/cli æ˜¯ commitlint` å·¥å…·çš„æ ¸å¿ƒã€‚
- `@commitlint/config-conventional` æ˜¯åŸºäº conventional commits è§„èŒƒçš„é…ç½®æ–‡ä»¶ã€‚
- `commitizen` æä¾›äº†ä¸€ä¸ªäº¤äº’å¼æ’°å†™commitä¿¡æ¯çš„æ’ä»¶
- [cz-git](https://cz-git.qbb.sh/zh/guide/)æ˜¯å›½äººå¼€å‘äº†è¿™ä¸€æ¬¾å·¥å…·ï¼Œå·¥ç¨‹æ€§æ›´å¼ºï¼Œè‡ªå®šä¹‰æ›´é«˜ï¼Œäº¤äº’æ€§æ›´å¥½ã€‚

é…ç½®å‘½ä»¤

```json
// package.json
"scripts": {
  // å…¶ä»–çœç•¥
	"commit": "git-cz"
},
"config": {
  "commitizen": {
    "path": "node_modules/cz-git"
  }
}
```

é…ç½®`cz-git`

```shell
touch commitlint.config.js
```

```js
/** @type {import('cz-git').UserConfig} */
export default {
  extends: ["@commitlint/config-conventional"],
  rules: {
    // @see: https://commitlint.js.org/#/reference-rules
    "body-leading-blank": [2, "always"],
    "footer-leading-blank": [1, "always"],
    "header-max-length": [2, "always", 108],
    "subject-empty": [2, "never"],
    "type-empty": [2, "never"],
    "subject-case": [0],
    "type-enum": [
      2,
      "always",
      [
        "feat",
        "fix",
        "docs",
        "style",
        "refactor",
        "perf",
        "test",
        "build",
        "ci",
        "chore",
        "revert",
        "wip",
        "workflow",
        "types",
        "release"
      ]
    ]
  },
  prompt: {
    types: [
      { value: "feat", name: "âœ¨ æ–°åŠŸèƒ½: æ–°å¢åŠŸèƒ½" },
      { value: "fix", name: "ğŸ› ä¿®å¤: ä¿®å¤ç¼ºé™·" },
      { value: "docs", name: "ğŸ“š æ–‡æ¡£: æ›´æ–°æ–‡æ¡£" },
      { value: "refactor", name: "ğŸ“¦ é‡æ„: ä»£ç é‡æ„ï¼ˆä¸æ–°å¢åŠŸèƒ½ä¹Ÿä¸ä¿®å¤ bugï¼‰" },
      { value: "perf", name: "ğŸš€ æ€§èƒ½: æå‡æ€§èƒ½" },
      { value: "test", name: "ğŸ§ª æµ‹è¯•: æ·»åŠ æµ‹è¯•" },
      { value: "chore", name: "ğŸ”§ å·¥å…·: æ›´æ”¹æ„å»ºæµç¨‹æˆ–è¾…åŠ©å·¥å…·" },
      { value: "revert", name: "âª å›æ»š: ä»£ç å›æ»š" },
      { value: "style", name: "ğŸ¨ æ ·å¼: æ ¼å¼è°ƒæ•´ï¼ˆä¸å½±å“ä»£ç è¿è¡Œï¼‰" }
    ],
    scopes: ["root", "backend", "frontend", "components", "utils"],
    allowCustomScopes: true,
    skipQuestions: ["body", "footerPrefix", "footer", "breaking"], // è·³è¿‡â€œè¯¦ç»†æè¿°â€å’Œâ€œåº•éƒ¨ä¿¡æ¯â€
    messages: {
      type: "ğŸ“Œ è¯·é€‰æ‹©æäº¤ç±»å‹:",
      scope: "ğŸ¯ è¯·é€‰æ‹©å½±å“èŒƒå›´ (å¯é€‰):",
      subject: "ğŸ“ è¯·ç®€è¦æè¿°æ›´æ”¹:",
      body: "ğŸ” è¯¦ç»†æè¿° (å¯é€‰):",
      footer: "ğŸ”— å…³è”çš„ ISSUE æˆ– BREAKING CHANGE (å¯é€‰):",
      confirmCommit: "âœ… ç¡®è®¤æäº¤?"
    }
  }
};
```

### husky

å®‰è£…`husky`

```shell
pnpm -Dw add husky
```

åˆå§‹åŒ–

```cmd
pnpx husky init
```

é…ç½®

```cmd
#!/usr/bin/env sh
pnpm lint:prettier && pnpm lint:eslint && pnpm lint:spellcheck
```

### lint-staged

å®‰è£…

```shell
pnpm -Dw add lint-staged
```

é…ç½®å‘½ä»¤

```json
"precommit": "lint-staged"
```

é…ç½®æ–‡ä»¶

```js
// .lintstagedrc.js
export default {
  "*.{js,ts,mjs,cjs,json,tsx,css,less,scss,vue,html,md}": ["cspell lint"],
  "*.{js,ts,vue,md}": ["prettier --write", "eslint"]
};
```

é‡æ–°é…ç½®husky

```cmd
#!/usr/bin/env sh
```

## å…¬å…±åº“æ‰“åŒ…

å®‰è£…`rollup`

```shell
pnpm -Dw add rollup @rollup/plugin-node-resolve @rollup/plugin-commonjs rollup-plugin-typescript2 @rollup/plugin-terser @vitejs/plugin-vue rollup-plugin-postcss
```

- `@rollup/plugin-node-resolve`: è§£æ node_modules ä¸­çš„ä¾èµ–
- `@rollup/plugin-commonjs`: å°† CommonJS æ¨¡å—è½¬ä¸º ESM
- `rollup-plugin-typescript2`: è®© Rollup æ”¯æŒ TS ç¼–è¯‘
- `@rollup/plugin-terser`ï¼š å‹ç¼©å’Œæ··æ·†
- `@vitejs/plugin-vue`ï¼š æ”¯æŒSFCç¼–è¯‘
- `rollup-plugin-postcss`ï¼š å¤„ç†cssä»£ç 

é…ç½®ï¼š ç•¥

## å­åŒ…é—´ä¾èµ–

```json
{
  "foo": "workspace:*",
  "bar": "workspace:^1.0.0"
}
```

## å•å…ƒæµ‹è¯•

å®‰è£…

```shell
pnpm -Dw add vitest @vitest/browser vitest-browser-vue vue
```

æ·»åŠ å‘½ä»¤

```json
"test": "vitest"
```

æ›´æ”¹`tsconfig.json`

```json
"types": ["vitest/globals", "@vitest/browser/matchers"],
"lib": ["esnext", "DOM"],
```

å®‰è£…vscodeæ’ä»¶ï¼š vitest

ç¼–å†™æµ‹è¯•è„šæœ¬ï¼š ç•¥

## å‘å¸ƒ

ç´¯äº†ï¼Œä¸æƒ³å†™äº†
